{"version":3,"sources":["modbus-io-config.js"],"names":["module","exports","RED","install","coreIO","require","node","watcher","config","fs","nodes","ModbusIOConfigNode","this","name","UNLIMITED_LISTENERS","createNode","format","addressOffset","setMaxListeners","path","lastUpdatedAt","lineReader","configData","err","message","on","line","push","JSON","parse","Date","now","warn","payload","allValueNamesFromIOFile","emit","internalDebug","curr","prev","mtime","LineByLineReader","done","unwatchFile"],"mappings":"aAQAA,OAAOC,QAAU,SAAUC,GAA3BF,QAAOC,sBAAyBE,UAC9B,IAAAC,EAAAC,QAAA,yBA0EIC,EAAAA,MAAKC,aAAL,mBAzEJF,SAAAG,GAIE,IAAMC,EAAKJ,QAAQ,YADrBH,EAAAQ,MAASC,WAAAA,KAAoBH,GAM3BI,KAAKC,KAAOL,EAAOK,KAJnBD,KAAME,KAAAA,EAAAA,KAENZ,KAAIQ,OAAMK,EAAWC,OAErBJ,KAAKC,cAAcA,EAAnBI,cAEA,IAAKD,EAALJ,KACAN,EAAKW,gBAXgB,GAarBX,EAAMA,cAAN,KACAA,IAAKY,EAAAA,IAAgBJ,EAAAA,iBAArBR,EAAAa,MACAb,EAAKc,cAAgB,gBAArBd,EAAAa,MACAb,EAAMe,WAAa,GAEnBf,EAAKgB,GAAAA,QAAL,SAAAC,GAEAF,EAAAA,cAAuBE,EAAAC,WAIvBH,EAAWI,GAAG,OAAQ,SAAUC,GAC1BA,GACFpB,EAAKgB,WAAWK,KAAKC,KAAKC,MAAMH,MAKlCpB,EAAKc,GAAAA,MAAL,WACAhB,EAAAA,cAAqB0B,KAAAC,MACrBzB,EAAK0B,cAAK,0BAAA1B,EAAAa,MAAEc,EAAAA,KAAO,CAAE7B,QAAO8B,EAAAA,wBAAlB5B,GAAAO,KAAA,kCAAAM,KAAAb,EAAAa,OAAiDN,EAAAA,KAAM,gBAAAP,EAAAgB,cACjEhB,EAAK6B,cAAK,+BAAV7B,EAAAa,MAGFf,EAAAA,QAAOgC,EAAAA,UAAc9B,EAAAa,KAAA,SAAAkB,EAAAC,GAMnB,GAJFhC,EAAKC,cAALD,yBAAAA,OAAuC+B,EAAAE,QACrCnC,EAAOgC,cAAPhC,2BAAAA,OAAAkC,EAA8CD,QAG1CA,EAAKE,QAAUD,EAAKC,MAAO,CAA/BnC,EAASmC,cAAc,kBAAQjC,EAAAa,MAC7Bf,EAAAA,WAAOgC,UACFd,EAAAA,cAGL,IAAMD,EAAa,IAAIjB,EAAOoC,iBAAiBlC,EAAKa,MAApDE,EAAMA,GAAAA,QAAiBjB,SAAOoC,GAE5BpC,EAAOgC,cAAcb,EAAIC,WAC1BH,EAFDI,GAAA,OAAA,SAAAC,GAKMA,GADNL,EAAAA,WAAcM,KAAQC,KAAAC,MAAUH,MAI/BL,EAJDI,GAAA,MAAA,WAOEnB,EAAKc,cAAgBU,KAAKC,MAD5BV,EAAAA,cAAqB,4BAAYf,EAAAa,MAC/Bb,EAAKc,KAAAA,CAAAA,QAAgBU,EAAKC,wBAA1BzB,GAAAO,KAAA,kCAAAM,KAAAb,EAAAa,OACAf,EAAAA,KAAOgC,gBAAc9B,EAAAgB,cACsCT,EAAAA,cAAM,iCAAvDP,EAAAa,SAEXb,EALDmB,GAAA,QAAA,SAAAgB,GAYFhC,EAAGiC,YAAYpC,EAAKa,MALlBf,EAAAA,QAAOgC,QACRK","file":"../modbus-io-config.js","sourcesContent":["/**\n Copyright (c) 2016,2017,2018,2019 Klaus Landsdorf (https://bianco-royal.com/)\n All rights reserved.\n node-red-contrib-modbus\n node-red-contrib-modbusio\n\n @author <a href=\"mailto:klaus.landsdorf@bianco-royal.de\">Klaus Landsdorf</a> (Bianco Royal)\n */\nmodule.exports = function (RED) {\n  'use strict'\n  require('source-map-support').install()\n  const coreIO = require('./core/modbus-io-core')\n\n  function ModbusIOConfigNode (config) {\n    const fs = require('fs-extra')\n    const UNLIMITED_LISTENERS = 0\n\n    RED.nodes.createNode(this, config)\n\n    this.name = config.name\n    this.path = config.path\n    this.format = config.format\n    this.addressOffset = config.addressOffset\n\n    const node = this\n    node.setMaxListeners(UNLIMITED_LISTENERS)\n    node.lastUpdatedAt = null\n    const lineReader = new coreIO.LineByLineReader(node.path)\n    coreIO.internalDebug('Read IO File ' + node.path)\n    node.configData = []\n\n    lineReader.on('error', function (err) {\n      coreIO.internalDebug(err.message)\n    })\n\n    lineReader.on('line', function (line) {\n      if (line) {\n        node.configData.push(JSON.parse(line))\n      }\n    })\n\n    lineReader.on('end', function () {\n      node.lastUpdatedAt = Date.now()\n      coreIO.internalDebug('Read IO Done From File ' + node.path)\n      node.warn({ payload: coreIO.allValueNamesFromIOFile(node), name: 'Modbus Value Names From IO File', path: node.path })\n      node.emit('updatedConfig', node.configData)\n    })\n\n    coreIO.internalDebug('Loading IO File Started For ' + node.path)\n\n    node.watcher = fs.watchFile(node.path, (curr, prev) => {\n      coreIO.internalDebug(`the current mtime is: ${curr.mtime}`)\n      coreIO.internalDebug(`the previous mtime was: ${prev.mtime}`)\n\n      if (curr.mtime !== prev.mtime) {\n        coreIO.internalDebug('Reload IO File ' + node.path)\n        node.configData = []\n        delete node.lastUpdatedAt\n\n        const lineReader = new coreIO.LineByLineReader(node.path)\n        lineReader.on('error', function (err) {\n          coreIO.internalDebug(err.message)\n        })\n\n        lineReader.on('line', function (line) {\n          if (line) {\n            node.configData.push(JSON.parse(line))\n          }\n        })\n\n        lineReader.on('end', function () {\n          node.lastUpdatedAt = Date.now()\n          coreIO.internalDebug('Reload IO Done From File ' + node.path)\n          node.warn({ payload: coreIO.allValueNamesFromIOFile(node), name: 'Modbus Value Names From IO File', path: node.path })\n          node.emit('updatedConfig', node.configData)\n        })\n\n        coreIO.internalDebug('Reloading IO File Started For ' + node.path)\n      }\n    })\n\n    node.on('close', function (done) {\n      fs.unwatchFile(node.path)\n      node.watcher.close()\n      done()\n    })\n  }\n\n  RED.nodes.registerType('modbus-io-config', ModbusIOConfigNode)\n}\n"]}