<script type="text/javascript">var nodeVersion=function(e){return{check:function(t){t.version=void 0===t.version?0:Number(t.version);const n=`<div id="version-update" class="ui-state-error ha-alert-box"><p><strong>Alert:</strong>This node will be updated to version ${t._def.defaults.version.value} from ${t.version} (<a href="${function(e){let t="";switch(e){case"api-current-state":t="current-state";break;case"api-call-service":t="call-service";break;case"poll-state":t="poll-state";break;case"server-state-changed":t="events-state"}return`https://zachowj.github.io/node-red-contrib-home-assistant-websocket/node/${t}.html#changelog`}(t.type)}#version" target="_blank" rel="noreferrer">changes</a>)</p></div>`;t.version<t._def.defaults.version.value&&e("#dialog-form").prepend(n)},ifStateLabels:function(e){if(this.halt_if||this.haltifstate){if(0===Number(this.version)||void 0===this.version){if(0===e)return"'If State' is false";if(1===e)return"'If State' is true"}if(0===e)return"'If State' is true";if(1===e)return"'If State' is false"}},labelStyle:function(){return`${this._def.defaults.version&&Number(this.version)!==this._def.defaults.version.value?"ha-node-label-legacy ":""}${this.name?"node_label_italic":""}`},update:function(t){t.version<t._def.defaults.version.value&&e("#node-input-version").val(t._def.defaults.version.value)}}}(jQuery),haServer=function(e,t){let n,o,i;function a(i,a){"_ADD_"!==o&&e.getJSON(`homeassistant/${o}/${i}`).done(e=>{a(e)}).fail(e=>{const o=t.nodes.node(n.val());o&&!0===o.dirty&&t.notify(`You probably haven't deployed since adding a server. Do that for autocomplete to work.\n${e.responseText}`,"error")})}return{init:function(o,a){n=e(a),i=o,i.server||function(){let e;t.nodes.eachConfig(t=>{"server"!==t.type||e||(e=t.id)}),e&&n.val(e)}()},autocomplete:function(e,t){const s=n.val();(i.server||s&&"_ADD_"!==s)&&(o=i.server||s,a(e,t)),n.change(()=>{o=n.val(),a(e,t)})}}}(jQuery,RED),exposeNode=function(e){let t;function n(){const t=e("#node-input-server").val();if(t&&"_ADD_"!==t)return t}function o(){if(!e("#integrationAlert").length){const t='<div id="integrationAlert" class="ui-state-error ha-alert-box"><strong>Attention:</strong> This node requires <a href="https://github.com/zachowj/hass-node-red" target="_blank">Node-RED custom integration <i class="fa fa-external-link external-link"></i></a> to be installed in Home Assistant for it to function.</strong></div>';e("#dialog-form").prepend(t)}e("#integrationAlert").toggle(0===t.integrationVersion)}function i(){0===t.integrationVersion&&e("#node-input-exposeToHomeAssistant").prop("checked",!1).trigger("change"),e("#exposeToHa").toggle(0!==t.integrationVersion)}return{init:function(a){t=a,function(){switch(t.type){case"ha-webhook":case"ha-entity":o();break;default:!function(){const n=e("<div />",{id:"exposeToHa",class:`form-row checkbox-option${"trigger-state"===t.type?"-left":""}`});e("<input />",{type:"checkbox",id:"node-input-exposeToHomeAssistant",checked:t.exposeToHomeAssistant}).on("change",(function(){e("#haConfigRow").toggle(!0===e("#node-input-exposeToHomeAssistant").is(":checked"))})).appendTo(n),e("<label />",{for:"node-input-exposeToHomeAssistant",text:"Expose to Home Assistant"}).appendTo(n);const o=e("<div />",{class:"form-row",id:"haConfigRow"}),i=e("<ol />",{id:"haConfig"}).appendTo(o),a=t.haConfig||[{property:"name",value:""},{property:"icon",value:""}];i.editableList({addButton:!1,header:e("<div>Home Assistant Config (optional)</div>"),addItem:function(t,n,o){const i=e("<div />").appendTo(t);e("<input />",{type:"text",name:"property",value:o.property,style:"width: 40%;",readonly:!0}).appendTo(i),e("<input />",{type:"text",name:"value",value:o.value,style:"margin-left: 10px;width: 55%;"}).attr("autocomplete","disable").appendTo(i)}}).editableList("addItems",a),e("#dialog-form").append(n).append(o),e("#node-input-exposeToHomeAssistant").trigger("change")}()}}();const s=function(){switch(t.type){case"ha-webhook":case"ha-entity":return o;default:return i}}();e("#node-input-server").on("change",()=>(function(o){n()?e.getJSON(`homeassistant/${n()}/version?_=${Date.now()}`).done(e=>{t.integrationVersion=e.version,o&&o(t)}):o(t)})(s))},getValues:function(){const t=[];return e("#haConfig").editableList("items").each((function(n){const o=e(this);t.push({property:o.find("input[name=property]").val(),value:o.find("input[name=value]").val()})})),t}}}(jQuery);</script>
<script type="text/javascript">var ifState=function(t){let e;const a=function(){const a=t("#clearIfState");if(!e.hasClass("red-ui-typedInput"))return;let n=t("#node-input-name").width()-t("#node-input-halt_if_compare").outerWidth();a.is(":visible")&&(n-=a.outerWidth(!0)),e.typedInput("width",n)};return{init:function(n,s,i){t("#error-if-state").remove(),e=t(n);const c=t(s),o={value:"entity",label:"entity."},r=["str","num","bool","re","jsonata","msg","flow","global",o];"currentState"!==i&&r.splice(5,1),e.after(' <a id="clearIfState" class="editor-button"><i class="fa fa-remove"></i></a>');const l=t("#clearIfState");e.typedInput({default:"str",types:r,typeField:"#node-input-halt_if_type"}),c.change((function(t){let a=r,n=["flow","global",o];switch(r.includes("msg")&&(n=["msg"].concat(n)),t.target.value){case"is":case"is_not":break;case"lt":case"lte":case"gt":case"gte":a=["num","jsonata"].concat(n);break;case"includes":case"does_not_include":a=["str","jsonata"].concat(n);break;case"jsonata":a=["jsonata"]}e.typedInput("types",a)})),c.trigger("change"),e.on("change",(function(t){t.currentTarget.value&&(l.show(),a())})),l.on("click",(function(){e.typedInput("type","str"),e.typedInput("value",""),t(this).hide(),a()})),e.val()||(l.hide(),a()),a()},resize:a}}(jQuery);</script>
<script type="text/javascript">RED.nodes.registerType("ha-wait-until",{category:"home_assistant",color:"#52C0F2",inputs:1,outputs:1,outputLabels:["","timed out"],icon:"wait-until.png",paletteLabel:"wait until",label:function(){return this.name||"wait until"},labelStyle:nodeVersion.labelStyle,defaults:{name:{value:""},server:{value:"",type:"server",required:!0},outputs:{value:1},entityId:{value:""},property:{value:""},comparator:{value:"is"},value:{value:""},valueType:{value:"str"},timeout:{value:0},timeoutUnits:{value:"seconds"},entityLocation:{value:"data"},entityLocationType:{value:"none"},checkCurrentState:{value:!0},blockInputOverrides:{value:!0}},oneditprepare:function(){haServer.init(this,"#node-input-server");let e=[],t=[];haServer.autocomplete("entities",t=>{e=t,$("#node-input-entityId").autocomplete({source:e,minLength:0})}),haServer.autocomplete("properties",e=>{t=e,$("#node-input-property").autocomplete({source:t,minLength:0})}),void 0===this.checkCurrentState&&$("#node-input-checkCurrentState").prop("checked",!1);const n={value:"entity",label:"entity."},a=["str","num","bool","re","jsonata","msg","flow","global",n];$("#node-input-value").typedInput({default:"str",types:a,typeField:"#node-input-valueType"}).typedInput("width","45%"),$("#node-input-comparator").change((function(e){let t=a;switch($("#node-input-property").prop("disabled","jsonata"===e.target.value),e.target.value){case"is":case"is_not":break;case"lt":case"lte":case"gt":case"gte":t=["num","jsonata","msg","flow","global",n];break;case"includes":case"does_not_include":t=["str","jsonata","msg","flow","global"];break;case"jsonata":t=["jsonata"]}$("#node-input-value").typedInput("types",t)})),$("#node-input-timeout").spinner({min:0});$("#node-input-entityLocation").typedInput({types:["msg","flow","global",{value:"none",label:"None",hasValue:!1}],typeField:"#node-input-entityLocationType"}).typedInput("width","68%"),void 0===this.blockInputOverrides&&$("#node-input-blockInputOverrides").prop("checked",!0)},oneditsave:function(){const e=$("#node-input-timeout").val()>0?2:1;$("#node-input-outputs").val(e)}});</script>
<script type="text/x-red" data-template-name="ha-wait-until"><div class="form-row"><label for="node-input-name"><i class="fa fa-tag"></i> Name</label> <input type="text" id="node-input-name" placeholder="Name"> <input type="hidden" id="node-input-outputs"></div><div class="form-row"><label for="node-input-server"><i class="fa fa-server"></i> Server</label> <input type="text" id="node-input-server"></div><div class="form-row"><label for="entityId"><i class="fa fa-cube"></i> Entity ID</label> <input type="text" id="node-input-entityId"></div><div class="form-row"><label for="node-input-property"><i class="fa fa-hand-paper-o"></i> Wait Until</label> <input type="text" id="node-input-property" placeholder="property"></div><div class="form-row"><select id="node-input-comparator" style="margin-right:5px;margin-left:105px;width:auto"><option value="is">is</option><option value="is_not">is not</option><option value="lt">&lt;</option><option value="lte">&lt;=</option><option value="gt">&gt;</option><option value="gte">&gt;=</option><option value="includes">in</option><option value="does_not_include">not in</option><option value="jsonata">JSONata</option></select> <input id="node-input-valueType" type="hidden"> <input id="node-input-value" type="text" placeholder="value" style="width:46%"></div><div class="form-row"><label for="node-input-timeout"><i class="fa fa-clock-o"></i> Timeout</label> <input type="text" id="node-input-timeout" style="text-align:end;width:50px!important"> <select id="node-input-timeoutUnits" style="width:auto!important"><option value="milliseconds">milliseconds</option><option value="seconds">seconds</option><option value="minutes">minutes</option><option value="hours">hours</option><option value="days">days</option></select></div><div class="form-row"><label for="node-input-entityLocation">Entity Location</label> <input type="hidden" id="node-input-entityLocationType"> <input type="text" id="node-input-entityLocation"></div><div class="form-row"><input type="checkbox" id="node-input-checkCurrentState" checked="checked" style="margin-left:105px;display:inline-block;width:auto;vertical-align:baseline">&nbsp; <label for="node-input-checkCurrentState" style="width:auto;margin-right:20px">Check against current state</label></div><div class="form-row checkbox-option"><input type="checkbox" id="node-input-blockInputOverrides">&nbsp; <label for="node-input-blockInputOverrides">Block Input Overrides</label></div></script>
<script type="text/x-red" data-help-name="ha-wait-until"><p>When an input is received the node will wait until the condition is met or the timeout occurs then will pass on the last received message</p><h3>Configuration</h3><dl class="message-properties"><dt>Entity ID <span text="required" class="badge">required</span><span class="property-type">string</span></dt><ul><li>Accepts <a href="https://zachowj.github.io/node-red-contrib-home-assistant-websocket/guide/mustache-templates.html" rel="noopener noreferrer">Mustache Templates</a></li></ul><dd>The id of an entity to use for the comparison.</dd><dt>Wait Until <span text="required" class="badge">required</span><span class="property-type">string</span></dt><dd>The <code>property</code> field will be checked against the <code>value</code> field using the comparator.</dd><dt>Timeout<span class="property-type">number</span></dt><dd>The amount of time to wait for the condition to become true before deactivating the node and passing the message object to the second output. If the timeout is equal to zero the node will wait indefinitely for the condition to be met.</dd><dt>Entity Location<span class="property-type">string</span></dt><dd>The entity object can also be pass with the message object.</dd><dt>Check against the current state<span class="property-type">boolean</span></dt><dd>When an input is received it will check the comparator against the current state instead of waiting for a state change.</dd></dl><h3>Input</h3><dl class="message-properties"><dt>reset<span class="property-type"></span></dt><dd>If the received message has this property set to any value the node will be set to inactive and the timeout cleared.</dd><dt>payload<span class="property-type">object</span></dt><dd>Override config values by passing in a property with a valid value.</dd><ul><li><code>entity_id</code></li><li><code>entityId</code> <span type="warning" text="deprecated" class="badge warning">deprecated</span></li><li><code>property</code></li><li><code>comparator</code></li><li><code>value</code></li><li><code>valueType</code></li><li><code>timeout</code></li><li><code>timeoutUnits</code></li><li><code>entityLocation</code></li><li><code>entityLocationType</code></li><li><code>checkCurrentState</code></li></ul></dl><h3>Output</h3><dl class="message-properties"><dd>Will output the last received message when the condition is true or the timeout occurs. If the condition becomes true the message will be pass to the first output. If the timeout passes the message will be sent to the second output.</dd></dl></script>
<style>#version-update{padding:.5em;margin-bottom:1em}#version-update p{margin:0}#version-update strong{padding-right:5px}#error-if-state{text-align:center;padding:5px;margin-top:5px}.form-row.checkbox-option input{margin-left:105px;margin-right:5px;display:inline-block;width:auto;vertical-align:top}.form-row.checkbox-option label{width:auto}.form-row.checkbox-option-left input{display:inline-block;margin-right:5px;width:auto;vertical-align:top}.form-row.checkbox-option-left label{width:auto;margin-right:20px}.ha-node-label-legacy{fill:#fdfd96;stroke-width:0;font-size:14px;pointer-events:none;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}li span.property-type{font-family:Helvetica Neue,Arial,Helvetica,sans-serif;color:#666;font-style:italic;font-size:11px;float:right}.ha-alert-box{padding:10px;margin-bottom:10px}.custom-block .custom-block-title{font-weight:600}.custom-block.danger,.custom-block.tip,.custom-block.warning{padding:.1rem 1.5rem;border-left-width:.5rem;border-left-style:solid;margin:1rem 0}.custom-block.tip{background-color:#f3f5f7;border-color:#42b983}.custom-block.warning{background-color:rgba(255,229,100,.3);border-color:#e7c000;color:#6b5900}.custom-block.warning .custom-block-title{color:#b29400}.custom-block.warning a{color:#6b5900}.custom-block.danger{background-color:#ffe6e6;border-color:#c00;color:#4d0000}.custom-block.danger .custom-block-title{color:#900}.custom-block.danger a{color:#4d0000}.button-box div.text-box{display:inline-block;position:relative;width:70%;height:20px}.button-box div.text-box div{position:absolute;left:0;right:40px}.button-box div.text-box div input{width:100%}.button-box div.text-box a{position:absolute;right:0;top:0}.badge{display:inline-block;font-size:12px;height:16px;line-height:16px;border-radius:3px;padding:0 6px;color:#fff}.badge,.badge.green,.badge.tip{background-color:#42b983}.badge.error{background-color:#da5961}.badge.warn,.badge.warning,.badge.yellow{background-color:#e7c000}.badge+.badge{margin-left:5px}</style>