"use strict";module.exports=function(r){require("source-map-support").install();var u=require("./modbus-basics"),d=require("./core/modbus-core"),l=require("./core/modbus-io-core"),c=require("debug")("contribModbus:read");r.nodes.registerType("modbus-read",function(e){r.nodes.createNode(this,e),this.name=e.name,this.topic=e.topic,this.unitid=e.unitid,this.dataType=e.dataType,this.adr=e.adr,this.quantity=e.quantity||1,this.rate=e.rate,this.rateUnit=e.rateUnit,this.delayOnStart=e.delayOnStart,this.startDelayTime=parseInt(e.startDelayTime)||10,this.showStatusActivities=e.showStatusActivities,this.showErrors=e.showErrors,this.connection=null,this.useIOFile=e.useIOFile,this.ioFile=r.nodes.getNode(e.ioFile),this.useIOForPayload=e.useIOForPayload,this.logIOActivities=e.logIOActivities;var a=this,t=null,o=null,i=!1;a.INPUT_TIMEOUT_MILLISECONDS=1e3,u.setNodeStatusTo("waiting",a);var s=r.nodes.getNode(e.server);function n(e){if("polling"!==e||!i){var t=u.setNodeStatusProperties(e,a.showStatusActivities);-1!==e.search("active")||"polling"===e?(i=!1,a.status({fill:t.fill,shape:t.shape,text:t.status+" ( "+a.rate+" "+u.get_timeUnit_name(a.rateUnit)+" ) "})):a.status({fill:t.fill,shape:t.shape,text:t.status})}}s&&(s.registerForModbus(a),u.initModbusClientEvents(a,s),a.onModbusInit=function(){u.setNodeStatusTo("initialize",a)},a.onModbusConnect=function(){a.delayOnStart?t=(t&&clearTimeout(t),setTimeout(a.startIntervalReading,a.INPUT_TIMEOUT_MILLISECONDS*a.startDelayTime)):(t&&clearTimeout(t),a.startIntervalReading()),n("connected")},a.startIntervalReading=function(){o=o||setInterval(a.modbusPollingRead,u.calc_rateByUnit(a.rate,a.rateUnit))},a.onModbusActive=function(){n("active")},a.onModbusError=function(e){u.setNodeStatusTo("failure",a),s.reconnectOnTimeout&&(o&&clearInterval(o),o=null),a.showErrors&&a.warn(e)},a.onModbusClose=function(){u.setNodeStatusTo("closed",a),o&&clearInterval(o),o=null},a.onModbusBroken=function(){s.reconnectOnTimeout&&(u.setNodeStatusTo("reconnecting after "+s.reconnectTimeout+" msec.",a),o&&clearInterval(o),o=null)},s.on("mbinit",a.onModbusInit),s.on("mbconnected",a.onModbusConnect),s.on("mbactive",a.onModbusActive),s.on("mberror",a.onModbusError),s.on("mbbroken",a.onModbusBroken),s.on("mbclosed",a.onModbusClose),a.modbusPollingRead=function(){if(s.client){var e={topic:a.topic||"polling",from:a.name,payload:{unitid:a.unitid,fc:d.functionCodeModbusRead(a.dataType),address:a.adr,quantity:a.quantity,messageId:d.getObjectId()}};a.showStatusActivities&&n("polling"),s.emit("readModbus",e,a.onModbusReadDone,a.onModbusReadError)}else n("waiting")},a.onModbusReadDone=function(e,t){a.showStatusActivities&&n("reading done"),function(e,t,o){if(a.useIOFile&&a.ioFile.lastUpdatedAt){a.logIOActivities&&l.internalDebug("node.adr:"+a.adr+" node.quantity:"+a.quantity);var i=l.nameValuesFromIOFile(a,o,e,t,a.adr),s=l.filterValueNames(a,i,d.functionCodeModbusRead(a.dataType),a.adr,a.quantity),n={topic:o.topic,responseBuffer:t,input:o};a.useIOForPayload?(n.payload=s,n.values=e):(n.payload=e,n.valueNames=s),a.send([n,{payload:t,values:e,input:o,valueNames:s}])}else a.send([{payload:e,responseBuffer:t,input:o},{payload:t,values:e,input:o}])}(e.data,e,t)},a.onModbusReadError=function(e,t){c(e.message),a.showErrors&&a.error(e,t),u.setModbusError(a,s,e,t)},a.on("close",function(e){o&&clearInterval(o),o=null,u.setNodeStatusTo("closed",a),s.deregisterForModbus(a,e)}))}),r.httpAdmin.post("/modbus/read/inject/:id",r.auth.needsPermission("modbus.inject.write"),function(e,t){var o=r.nodes.getNode(e.params.id);if(o)try{o.modbusPollingRead(),t.sendStatus(200)}catch(e){t.sendStatus(500),o.error(r._("modbusinject.failed",{error:e.toString()}))}else t.sendStatus(404)})};
//# sourceMappingURL=maps/modbus-read.js.map
