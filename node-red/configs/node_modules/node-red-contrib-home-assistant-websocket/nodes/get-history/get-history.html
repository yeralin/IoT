<script type="text/javascript">var nodeVersion=function(e){return{check:function(t){t.version=void 0===t.version?0:Number(t.version);const n=`<div id="version-update" class="ui-state-error ha-alert-box"><p><strong>Alert:</strong>This node will be updated to version ${t._def.defaults.version.value} from ${t.version} (<a href="${function(e){let t="";switch(e){case"api-current-state":t="current-state";break;case"api-call-service":t="call-service";break;case"poll-state":t="poll-state";break;case"server-state-changed":t="events-state"}return`https://zachowj.github.io/node-red-contrib-home-assistant-websocket/node/${t}.html#changelog`}(t.type)}#version" target="_blank" rel="noreferrer">changes</a>)</p></div>`;t.version<t._def.defaults.version.value&&e("#dialog-form").prepend(n)},ifStateLabels:function(e){if(this.halt_if||this.haltifstate){if(0===Number(this.version)||void 0===this.version){if(0===e)return"'If State' is false";if(1===e)return"'If State' is true"}if(0===e)return"'If State' is true";if(1===e)return"'If State' is false"}},labelStyle:function(){return`${this._def.defaults.version&&Number(this.version)!==this._def.defaults.version.value?"ha-node-label-legacy ":""}${this.name?"node_label_italic":""}`},update:function(t){t.version<t._def.defaults.version.value&&e("#node-input-version").val(t._def.defaults.version.value)}}}(jQuery),haServer=function(e,t){let n,o,i;function a(i,a){"_ADD_"!==o&&e.getJSON(`homeassistant/${o}/${i}`).done(e=>{a(e)}).fail(e=>{const o=t.nodes.node(n.val());o&&!0===o.dirty&&t.notify(`You probably haven't deployed since adding a server. Do that for autocomplete to work.\n${e.responseText}`,"error")})}return{init:function(o,a){n=e(a),i=o,i.server||function(){let e;t.nodes.eachConfig(t=>{"server"!==t.type||e||(e=t.id)}),e&&n.val(e)}()},autocomplete:function(e,t){const s=n.val();(i.server||s&&"_ADD_"!==s)&&(o=i.server||s,a(e,t)),n.change(()=>{o=n.val(),a(e,t)})}}}(jQuery,RED),exposeNode=function(e){let t;function n(){const t=e("#node-input-server").val();if(t&&"_ADD_"!==t)return t}function o(){if(!e("#integrationAlert").length){const t='<div id="integrationAlert" class="ui-state-error ha-alert-box"><strong>Attention:</strong> This node requires <a href="https://github.com/zachowj/hass-node-red" target="_blank">Node-RED custom integration <i class="fa fa-external-link external-link"></i></a> to be installed in Home Assistant for it to function.</strong></div>';e("#dialog-form").prepend(t)}e("#integrationAlert").toggle(0===t.integrationVersion)}function i(){0===t.integrationVersion&&e("#node-input-exposeToHomeAssistant").prop("checked",!1).trigger("change"),e("#exposeToHa").toggle(0!==t.integrationVersion)}return{init:function(a){t=a,function(){switch(t.type){case"ha-webhook":case"ha-entity":o();break;default:!function(){const n=e("<div />",{id:"exposeToHa",class:`form-row checkbox-option${"trigger-state"===t.type?"-left":""}`});e("<input />",{type:"checkbox",id:"node-input-exposeToHomeAssistant",checked:t.exposeToHomeAssistant}).on("change",(function(){e("#haConfigRow").toggle(!0===e("#node-input-exposeToHomeAssistant").is(":checked"))})).appendTo(n),e("<label />",{for:"node-input-exposeToHomeAssistant",text:"Expose to Home Assistant"}).appendTo(n);const o=e("<div />",{class:"form-row",id:"haConfigRow"}),i=e("<ol />",{id:"haConfig"}).appendTo(o),a=t.haConfig||[{property:"name",value:""},{property:"icon",value:""}];i.editableList({addButton:!1,header:e("<div>Home Assistant Config (optional)</div>"),addItem:function(t,n,o){const i=e("<div />").appendTo(t);e("<input />",{type:"text",name:"property",value:o.property,style:"width: 40%;",readonly:!0}).appendTo(i),e("<input />",{type:"text",name:"value",value:o.value,style:"margin-left: 10px;width: 55%;"}).attr("autocomplete","disable").appendTo(i)}}).editableList("addItems",a),e("#dialog-form").append(n).append(o),e("#node-input-exposeToHomeAssistant").trigger("change")}()}}();const s=function(){switch(t.type){case"ha-webhook":case"ha-entity":return o;default:return i}}();e("#node-input-server").on("change",()=>(function(o){n()?e.getJSON(`homeassistant/${n()}/version?_=${Date.now()}`).done(e=>{t.integrationVersion=e.version,o&&o(t)}):o(t)})(s))},getValues:function(){const t=[];return e("#haConfig").editableList("items").each((function(n){const o=e(this);t.push({property:o.find("input[name=property]").val(),value:o.find("input[name=value]").val()})})),t}}}(jQuery);</script>
<script type="text/javascript">var ifState=function(t){let e;const a=function(){const a=t("#clearIfState");if(!e.hasClass("red-ui-typedInput"))return;let n=t("#node-input-name").width()-t("#node-input-halt_if_compare").outerWidth();a.is(":visible")&&(n-=a.outerWidth(!0)),e.typedInput("width",n)};return{init:function(n,s,i){t("#error-if-state").remove(),e=t(n);const c=t(s),o={value:"entity",label:"entity."},r=["str","num","bool","re","jsonata","msg","flow","global",o];"currentState"!==i&&r.splice(5,1),e.after(' <a id="clearIfState" class="editor-button"><i class="fa fa-remove"></i></a>');const l=t("#clearIfState");e.typedInput({default:"str",types:r,typeField:"#node-input-halt_if_type"}),c.change((function(t){let a=r,n=["flow","global",o];switch(r.includes("msg")&&(n=["msg"].concat(n)),t.target.value){case"is":case"is_not":break;case"lt":case"lte":case"gt":case"gte":a=["num","jsonata"].concat(n);break;case"includes":case"does_not_include":a=["str","jsonata"].concat(n);break;case"jsonata":a=["jsonata"]}e.typedInput("types",a)})),c.trigger("change"),e.on("change",(function(t){t.currentTarget.value&&(l.show(),a())})),l.on("click",(function(){e.typedInput("type","str"),e.typedInput("value",""),t(this).hide(),a()})),e.val()||(l.hide(),a()),a()},resize:a}}(jQuery);</script>
<script type="text/javascript">RED.nodes.registerType("api-get-history",{category:"home_assistant",color:"#52C0F2",inputs:1,outputs:1,icon:"history.png",paletteLabel:"get history",label:function(){if(this.name)return this.name;if(this.useRelativeTime&&this.relativeTime)return this.relativeTime;if(this.startdate){const t=new Date(this.startdate);return`${t.toLocaleDateString()} ${t.toLocaleTimeString()}`}return"get history"},labelStyle:nodeVersion.labelStyle,defaults:{name:{value:""},server:{value:"",type:"server",required:!0},startdate:{value:""},enddate:{value:""},entityid:{value:""},entityidtype:{value:""},useRelativeTime:{value:!1},relativeTime:{value:""},flatten:{value:!0},output_type:{value:"array"},output_location_type:{value:"msg"},output_location:{value:"payload"}},oneditprepare:function(){const t=$("#entity_id");t.val(this.entityid),this.entityidtype=this.entityidtype||"is",$("#node-input-entityidtype").val(this.entityidtype),haServer.init(this,"#node-input-server");let e=[];haServer.autocomplete("entities",i=>{e=i,t.autocomplete({source:e,minLength:0})}),$("#node-input-useRelativeTime").on("change",(function(){this.checked?($(".relative_row").show(),$(".date_row").hide()):($(".relative_row").hide(),$(".date_row").show())})),void 0===this.output_location&&$("#node-input-output_location").val("payload"),void 0===this.output_type&&$("#node-input-output_type").val("array"),$("#node-input-output_location").typedInput({types:["msg","flow","global"],typeField:"#node-input-output_location_type"}),$("#node-input-output_type").on("change",t=>$(".output-option").toggle("array"===t.target.value)).trigger("change")},oneditsave:function(){this.entityid=$("#entity_id").val().trim()}});</script>
<script type="text/x-red" data-template-name="api-get-history"><div class="form-row"><label for="node-input-name"><i class="fa fa-tag"></i> Name</label> <input type="text" id="node-input-name" placeholder="Name"></div><div class="form-row"><label for="node-input-server"><i class="fa fa-server"></i> Server</label> <input type="text" id="node-input-server"></div><!-- Comparator Selection --><div class="form-row"><label for="entity_id"><i class="fa fa-date"></i> Entity ID</label> <select type="text" id="node-input-entityidtype" style="width:80px"><option value="is">Is</option><option value="includes">Includes</option></select> <input type="text" id="entity_id" style="width:52%"></div><div class="form-row"><input type="checkbox" id="node-input-useRelativeTime" style="display:inline-block;width:auto;vertical-align:top;margin-left:105px">&nbsp; <label for="node-input-useRelativeTime" style="width:auto">Use Relative Time</label></div><div class="form-row relative_row"><label for="node-input-relativeTime"><i class="fa fa-date"></i> In the Last</label> <input type="text" id="node-input-relativeTime" autofocus="autofocus" placeholder="20 minutes"></div><div class="form-row date_row"><label for="node-input-startdate"><i class="fa fa-date"></i> Start Date</label> <input type="text" id="node-input-startdate" autofocus="autofocus"></div><div class="form-row date_row"><label for="node-input-enddate"><i class="fa fa-date"></i> End Date</label> <input type="text" id="node-input-enddate"></div><div class="form-row form-tips date_row"><ul><li>dates must be in ISO format</li><li>example: "2018-01-27T13:00:00+00:00"</li></ul></div><div class="form-row form-tips relative_row"><p><code>timestring</code> will parse the following keywords into time values:</p><ol><li><code>ms, milli, millisecond, milliseconds</code> - will parse to milliseconds</li><li><code>s, sec, secs, second, seconds</code> - will parse to seconds</li><li><code>m, min, mins, minute, minutes</code> - will parse to minutes</li><li><code>h, hr, hrs, hour, hours</code> - will parse to hours</li><li><code>d, day, days</code> - will parse to days</li><li><code>w, week, weeks</code> - will parse to weeks</li><li><code>mon, mth, mths, month, months</code> - will parse to months</li><li><code>y, yr, yrs, year, years</code> - will parse to years</li></ol></div><div class="form-row"><input type="checkbox" id="node-input-flatten" style="display:inline-block;width:auto;vertical-align:top;margin-left:105px">&nbsp; <label for="node-input-flatten" style="width:auto">Flatten Results</label></div><div class="form-row"><label for="node-input-output_type">Output Type</label> <select id="node-input-output_type"><option value="array">Array</option><option value="split">Split</option></select></div><div class="form-row output-option" id="output_location"><label for="node-input-output_location">Output Location</label> <input type="hidden" id="node-input-output_location_type"> <input type="text" id="node-input-output_location"></div></script>
<script type="text/x-red" data-help-name="api-get-history"><p>Fetches history from Home Assistant (all history for the past day by default)</p><h3>Configuration</h3><dl class="message-properties"><dt>Entity ID<span class="property-type">string</span></dt><dd>Exact entity_id to fetch history for must be an exact match as is passed directly to the Home Assistant.</dd><dt>Entity ID Type<span class="property-type">string</span></dt><ul><li>Values: <code>is</code> | <code>includes</code></li><li>Default: <code>is</code></li></ul><dd><code>is</code> or <code>includes</code> depending on the match type.</dd><div class="custom-block warning"><p class="custom-block-title">WARNING</p><p><code>includes</code> fetches all history for the time period then filters according to the value, this will be less performant than exact <code>is</code> matching</p></div><dt>Start Date<span class="property-type">string</span></dt><ul><li>Values: ISO Format Date</li><li>Default: 24 hours prior</li></ul><dd>Date to start fetching history from. Will override the configuration if passed in</dd><dd><strong>Also See:</strong></dd><ul><li><a href="https://en.wikipedia.org/wiki/ISO_8601">https://en.wikipedia.org/wiki/ISO_8601</a></li></ul><dt>End Date<span class="property-type">string</span></dt><ul><li>Values: ISO Format Date</li><li>Default: 24 hours from start date</li></ul><dd>The end date to fetch history too. Will override the configuration if passed in</dd><dd><strong>Also See:</strong></dd><ul><li><a href="https://en.wikipedia.org/wiki/ISO_8601">https://en.wikipedia.org/wiki/ISO_8601</a></li></ul><dt>Use Relative Time<span class="property-type">boolean</span></dt><ul><li>Default: <code>false</code></li></ul><dd>A checkbox to use relative time or not.</dd><dt>In the Last<span class="property-type">string</span></dt><dd>A time string that will be parsed the following keywords into time values.</dd><dd>Example: <code>4h 30m</code> = The last 4 hours and 30 minutes</dd><pre><code>ms, milli, millisecond, milliseconds - will parse to milliseconds
s, sec, secs, second, seconds - will parse to seconds
m, min, mins, minute, minutes - will parse to minutes
h, hr, hrs, hour, hours - will parse to hours
d, day, days - will parse to days
w, week, weeks - will parse to weeks
mon, mth, mths, month, months - will parse to months
y, yr, yrs, year, years - will parse to years
</code></pre><dt>Flatten Results<span class="property-type"></span></dt><dd>Instead of returning the data from home assistant ( array for each entity_id ) return one flattened array of one item per history entry</dd><dt>Output Types<span class="property-type">string</span></dt><ul><li>Values: <code>array</code> | <code>split</code></li><li>Default: <code>array</code></li></ul></dl><h3>Inputs</h3><dl class="message-properties"><dd>All properties of <code>msg.payload</code></dd><dt>entity_id<span class="property-type">string</span></dt><ul><li>Alias: <code>msg.entityid</code> <span type="warning" text="deprecated" class="badge warning">deprecated</span></li></ul><dt>startdate<span class="property-type">string</span></dt><ul><li>Values: ISO Format Date</li><li>Alias: <code>msg.startdate</code> <span type="warning" text="deprecated" class="badge warning">deprecated</span></li></ul><dt>enddate<span class="property-type">string</span></dt><ul><li>Values: ISO Format Date</li><li>Alias: <code>msg.enddate</code> <span type="warning" text="deprecated" class="badge warning">deprecated</span></li></ul><dt>relativetime<span class="property-type">string</span></dt><ul><li>Alias: <code>msg.relativetime</code> <span type="warning" text="deprecated" class="badge warning">deprecated</span></li></ul><dd>If <code>relativetime</code> exists <code>startdate</code> and <code>enddate</code> will be ignored.</dd><dt>flatten<span class="property-type">boolean</span></dt><ul><li>Alias: <code>msg.flatten</code> <span type="warning" text="deprecated" class="badge warning">deprecated</span></li></ul></dl><h3>Outputs</h3><dl class="message-properties"><dt>payload<span class="property-type">array</span></dt><dd>The history returned by home-assistant, which is an array of arrays where each array entry contains history objects for one particular entity</dd><dt>startdate<span class="property-type">string</span></dt><dd>ISO date string used to fetch history</dd><dt>enddate<span class="property-type">string</span></dt><dd>ISO date string used to fetch history</dd><dt>entity_id<span class="property-type">string</span></dt><dd>The entity id string used during fetch history call</dd><dd>Example output of <code>msg</code>:</dd><pre><code class="language-json">{
  &quot;startdate&quot;: &quot;2020-01-11T16:41:31.086Z&quot;,
  &quot;enddate&quot;: &quot;2020-01-14T16:41:31.086Z&quot;,
  &quot;entityid&quot;: &quot;light.kitchen_light&quot;,
  &quot;payload&quot;: [
    {
      &quot;attributes&quot;: {
        &quot;friendly_name&quot;: &quot;Kitchen Light&quot;,
        &quot;icon&quot;: &quot;mdi:light-switch&quot;,
      },
      &quot;context&quot;: {
        &quot;id&quot;: &quot;850e510e36fb494c9abc79e01e897d54&quot;,
        &quot;parent_id&quot;: null,
        &quot;user_id&quot;: null
      },
      &quot;entity_id&quot;: &quot;light.kitchen_light&quot;,
      &quot;last_changed&quot;: &quot;2019-12-28T06:47:28.618000+00:00&quot;,
      &quot;last_updated&quot;: &quot;2019-12-28T06:47:28.618000+00:00&quot;,
      &quot;state&quot;: &quot;off&quot;
    },
    {
      &quot;attributes&quot;: {
        &quot;brightness&quot;: 28,
        &quot;friendly_name&quot;: &quot;Kitchen Light&quot;,
        &quot;icon&quot;: &quot;mdi:light-switch&quot;,
      },
      &quot;context&quot;: {
        &quot;id&quot;: &quot;4d4abe29f2bc43dab39101193f1fefe4&quot;,
        &quot;parent_id&quot;: null,
        &quot;user_id&quot;: null
      },
      &quot;entity_id&quot;: &quot;light.kitchen_light&quot;,
      &quot;last_changed&quot;: &quot;2019-12-28T07:48:11.514137+00:00&quot;,
      &quot;last_updated&quot;: &quot;2019-12-28T07:48:11.514137+00:00&quot;,
      &quot;state&quot;: &quot;on&quot;
    },
    ...
  ]
}
</code></pre></dl><h3>References</h3><dl class="message-properties"><ul><li><a href="https://www.home-assistant.io/integrations/history">Home Assistant History Component</a></li><li><a href="https://developers.home-assistant.io/docs/en/external_api_rest.html#get-apihistoryperiodlttimestamp">Home Assistant API: /api/history/period</a></li></ul></dl></script>
<style>#version-update{padding:.5em;margin-bottom:1em}#version-update p{margin:0}#version-update strong{padding-right:5px}#error-if-state{text-align:center;padding:5px;margin-top:5px}.form-row.checkbox-option input{margin-left:105px;margin-right:5px;display:inline-block;width:auto;vertical-align:top}.form-row.checkbox-option label{width:auto}.form-row.checkbox-option-left input{display:inline-block;margin-right:5px;width:auto;vertical-align:top}.form-row.checkbox-option-left label{width:auto;margin-right:20px}.ha-node-label-legacy{fill:#fdfd96;stroke-width:0;font-size:14px;pointer-events:none;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}li span.property-type{font-family:Helvetica Neue,Arial,Helvetica,sans-serif;color:#666;font-style:italic;font-size:11px;float:right}.ha-alert-box{padding:10px;margin-bottom:10px}.custom-block .custom-block-title{font-weight:600}.custom-block.danger,.custom-block.tip,.custom-block.warning{padding:.1rem 1.5rem;border-left-width:.5rem;border-left-style:solid;margin:1rem 0}.custom-block.tip{background-color:#f3f5f7;border-color:#42b983}.custom-block.warning{background-color:rgba(255,229,100,.3);border-color:#e7c000;color:#6b5900}.custom-block.warning .custom-block-title{color:#b29400}.custom-block.warning a{color:#6b5900}.custom-block.danger{background-color:#ffe6e6;border-color:#c00;color:#4d0000}.custom-block.danger .custom-block-title{color:#900}.custom-block.danger a{color:#4d0000}.button-box div.text-box{display:inline-block;position:relative;width:70%;height:20px}.button-box div.text-box div{position:absolute;left:0;right:40px}.button-box div.text-box div input{width:100%}.button-box div.text-box a{position:absolute;right:0;top:0}.badge{display:inline-block;font-size:12px;height:16px;line-height:16px;border-radius:3px;padding:0 6px;color:#fff}.badge,.badge.green,.badge.tip{background-color:#42b983}.badge.error{background-color:#da5961}.badge.warn,.badge.warning,.badge.yellow{background-color:#e7c000}.badge+.badge{margin-left:5px}</style>